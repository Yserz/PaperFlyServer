<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui">

	<f:view contentType="text/html">

		<h:head>
			<title>Start Page</title>
			<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
			<script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
		</h:head>
		<h:body>
			<div>
				<input id="msg" type="text"></input>
				<input id="send" type="submit" value="Send" onclick="send();" />
				<input type="submit" value="Logout" onclick="logout();" />
			</div>
			<div id="messages"></div>
			<script type="text/javascript">
					//adress = '77.186.136.122';
//					adress = '46.137.173.175:8080';
					var adress = location.host;
					var consumerKey = "";
					var consumerSecret = "";


					console.log(adress);

					console.log(":::LOGIN");
					$.ajax({
						type: "GET",
						dataType: "json",
						url: "http://" + adress + "/PaperFlyServer-web/rest/v1/auth/login",
						async: false,
						headers: {
							"user": "yser@mail.de",
							"pw": "123456"
						},
						complete: function(jqXHR, textStatus) {
							switch (jqXHR.status) {
								case 404:
									console.log(jqXHR);
								case 500:
									console.log(jqXHR);
								default:

									try {
										var o = $.parseJSON(jqXHR.responseText);
										console.log(jqXHR.responseText);
										console.log(o.consumerKey);
										console.log(o.consumerSecret);
										consumerKey = o.consumerKey;
										consumerSecret = o.consumerSecret;
									} catch (e) {
										console.log(jqXHR.responseText);
										console.log(e);
									}

							}
						}
					});
					function s4() {
						return Math.floor((1 + Math.random()) * 0x10000)
								.toString(16)
								.substring(1);
					}


					function guid() {
						return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
								s4() + '-' + s4() + s4() + s4();
					}
					var nonce = guid();
					var timestamp = Math.round(new Date().getTime() / 1000);

					console.log("nonce: " + nonce);
					console.log("timestamp: " + timestamp);


					console.log(":::GET_ACCOUNT");
					$.ajax({
						type: "GET",
						dataType: "json",
						url: "http://" + adress + "/PaperFlyServer-web/rest/v1/account/username",
						async: false,
						headers: {
							'Authorization': 'OAuth oauth_signature="' + consumerSecret + '", oauth_version="1.0", oauth_nonce="' + nonce + '", oauth_signature_method="HMAC-SHA1", oauth_consumer_key="' + consumerKey + '", oauth_timestamp="' + timestamp + '"'
						},
						complete: function(jqXHR, textStatus) {
							switch (jqXHR.status) {
								case 404:
									console.log(jqXHR);
								case 500:
									console.log(jqXHR);
								default:
									console.log(jqXHR.responseText);
							}
						}
					});

					var webSocket =
							new WebSocket("ws://" + adress + "/PaperFlyServer-web/ws/chat/global");
					webSocket.onerror = function(event) {
						onError(event);
					};
					webSocket.onopen = function(event) {
						onOpen(event);
					};
					webSocket.onmessage = function(event) {
						onMessage(event);
					};
					function onMessage(event) {
						document.getElementById('messages').innerHTML
								+= '<br />' + $.parseJSON(event.data).body;
					}

					function onOpen(event) {
						document.getElementById('messages').innerHTML
								= 'Connection established';
						console.log(":::GET_ALL_ROOMS");
//						$.ajax({
//							type: "GET",
//							dataType: "json",
//							url: "http://" + adress + "/PaperFlyServer-web/rest/v1/room/all",
//							async: false,
//							headers: {
//								"Authorization": "OAuth"
//							},
//							complete: function(jqXHR, textStatus) {
//								switch (jqXHR.status) {
//									case 404:
//										console.log(jqXHR);
//									case 500:
//										console.log(jqXHR);
//									default:
//										console.log(jqXHR.responseText);
//								}
//							}
//						});
					}

					function onError(event) {
						console.log(JSON.stringify(event));
						console.log(event);
						alert(event);
					}

					function send() {
						var msg = document.getElementById('msg').value;
//						alert(JSON.stringify({text: msg}));
						webSocket.send(JSON.stringify(
								{
									body: msg
								}
						));
						document.getElementById('msg').value = '';
						console.log(":::LOCATE_ACCOUNT");
						$.ajax({
							type: "GET",
							dataType: "json",
							url: "http://" + adress + "/PaperFlyServer-web/rest/v1/room/locateAccount/username",
							async: false,
							headers: {
								'Authorization': 'OAuth oauth_signature="' + consumerSecret + '", oauth_version="1.0", oauth_nonce="' + nonce + '", oauth_signature_method="HMAC-SHA1", oauth_consumer_key="' + consumerKey + '", oauth_timestamp="' + timestamp + '"'
							},
							complete: function(jqXHR, textStatus) {
								switch (jqXHR.status) {
									case 404:
										console.log(jqXHR);
									case 500:
										console.log(jqXHR);
									default:
										console.log(jqXHR.responseText);
								}
							}
						});
						console.log(":::GET_ALL_ACCOUNTS_IN_ROOM");
						$.ajax({
							type: "GET",
							dataType: "json",
							url: "http://" + adress + "/PaperFlyServer-web/rest/v1/room/accounts/7",
							async: false,
							headers: {
								"Authorization": "OAuth"
							},
							complete: function(jqXHR, textStatus) {
								switch (jqXHR.status) {
									case 404:
										console.log(jqXHR);
									case 500:
										console.log(jqXHR);
									default:
										console.log(jqXHR.responseText);
								}
							}
						});

						return false;
					}
					document.getElementById('msg').onkeypress = function(e) {
						if (!e)
							e = window.event;
						var keyCode = e.keyCode || e.which;
						if (keyCode == '13') {
							send();
							return false;
						}
					};
					function logout() {
						console.log(":::LOGOUT");
						$.ajax({
							type: "GET",
							dataType: "json",
							url: "http://" + adress + "/PaperFlyServer-web/rest/v1/auth/logout",
							async: false,
							headers: {
								"Authorization": "OAuth"
							},
							complete: function(jqXHR, textStatus) {
								switch (jqXHR.status) {
									case 404:
										console.log(jqXHR);
									case 500:
										console.log(jqXHR);
									default:
										console.log(jqXHR.responseText);
								}
							}
						});
						webSocket.close();
						document.getElementById('messages').innerHTML
								= 'Successfully logged out!';
						document.getElementById('msg').disabled = true;
						document.getElementById('send').disabled = true;
					}
			</script>
		</h:body>
	</f:view>
</html>
